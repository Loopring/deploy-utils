const BN = require("bn.js");
const fs = require("fs");
const txDecoder = require("ethereum-tx-decoder");
const abi = require("ethereumjs-abi");
const Web3 = require("web3");

const web3 = new Web3(new Web3.providers.HttpProvider("https://mainnet.infura.io/hM4sFGiBdqbnGTxk5YT2"));

const delegateABI = fs.readFileSync("./TokenTransferDelegate.abi", "ascii");
const erc20ABI = fs.readFileSync("./ERC20.abi", "ascii");
const delegateAddress = "0x17233e07c67d086464fD408148c3ABB56245FA64";
const TokenContract = web3.eth.contract(JSON.parse(erc20ABI));

function bnToNumber(bn) {
  const bnStr = bn.toString(10);
  return parseInt(bnStr, 10);
}

async function printSpendable(owner, tokenAddr) {
  console.log("~".repeat(32));
  console.log(owner, tokenAddr);

  const token = TokenContract.at(tokenAddr);
  const balance = await token.balanceOf(owner);
  const allowance = await token.allowance(owner, delegateAddress);
  console.log("balance:", balance.toNumber() / 1e18);
  console.log("allowance:", allowance.toNumber() / 1e18);
}

async function parse(rawTx) {
  const protocolAbi = fs.readFileSync("./LoopringProtocolImpl.abi", "ascii");
  // console.log("protocolAbi", protocolAbi);

  const fnDecoder = new txDecoder.FunctionDecoder(protocolAbi);
  const decodedTx = txDecoder.decodeTx(rawTx);
  // console.log(decodedTx);

  const arrayish = fnDecoder.decodeFn(decodedTx.data);
  // console.log("arrayish:", arrayish);

  console.log("addresses:", arrayish[0]);

  const orderOwner1 = arrayish[0][0][0];
  const token1 = arrayish[0][0][1];
  const orderOwner2 = arrayish[0][1][0];
  const token2 = arrayish[0][1][1];

  await printSpendable(orderOwner1, token1);
  await printSpendable(orderOwner2, token2);

  const uintArray = arrayish[1];
  uintArray.forEach((arr) => {
    console.log("-".repeat(32));
    arr.forEach((bn, i) => {
      const num = bnToNumber(bn);
      if (i === 2 || i === 3) {
        console.log(new Date(bn * 1000));
      } else {
        console.log((num/1e18).toFixed(6));
      }
    });
  });

}

async function main() {
  const rawTx = "0xf906eb1b850684ee18008307a120948d8812b72d1e4ffcec158d25f56748b7d67c1e7880b90684e78aadb20000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000003e0000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000004a0000000000000000000000000000000000000000000000000000000000000054000000000000000000000000000000000000000000000000000000000000005e000000000000000000000000056447c02767ba621f103c0f3dbf564dbcacf284b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000012788951bb4d8efa049fb7c7d3e3421014bd0e5f0000000000000000000000001b793e49237758dbd8b752afc9eb4b329d5da01600000000000000000000000056447c02767ba621f103c0f3dbf564dbcacf284b00000000000000000000000001249c1c70452bb2c094073c060a83967d065a750000000000000000000000001941b8cdab08d5b3cd6b1a08f91a8201551ba130000000000000000000000000ef68e7c694f40c8202821edf525de3782458639f0000000000000000000000008e63bb7af326de3fc6e09f4c8d54a75c6e236aba000000000000000000000000ef347d092e47fe4aca1eee09c5f735b6eba844a8000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000001b1ae4d6e2ef50000000000000000000000000000000000000000000000000001043561a8829300000000000000000000000000000000000000000000000000000000000005be53997000000000000000000000000000000000000000000000000000000005c0cc697000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001b1ae4d6e2ef500000000000000000000000000000000000000000000000000001a055690d9db80000000000000000000000000000000000000000000000000002b5e3af16b1880000000000000000000000000000000000000000000000000000000000005be53997000000000000000000000000000000000000000000000000000000005c0cc6970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a055690d9db800000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001b000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000004acf051eef5e6bc9b50f5e1893a33249b86a917ebc358fbcb020c6b5a7cd59177441e25a906386be0bc74ef6962d6b20276dcc69ddd6db82b5db1cf757b9e72aaa3295a78299ebf18d7abc88f4b3eeb5101d370b223bc5f11ee945d3bef8d3a227714fb678fff8393186c7a1e706e64cc232fcb58be2bd7fdef59339bb80652a300000000000000000000000000000000000000000000000000000000000000042095ffa98a58d0823dad2cce3524acf76e175904357399520cb7185623436116128b1e1bcac9adceac3f18ca9e927a2591c69ec2c21101339e02ba595e955cdf103b19d78619fcffce3a6f860d4d4d16d8b14741f87e75b9288936d77bf1d4031b74263328380a2da5a6df7d3707b0671c1a5f07a3882202164d4f0b6d62f8771ba08497c25ab28e845ce22a00c2bff25575daab3e2d13d3accc2c7897ba66d02793a01a93ecc559ff1c251636d4261dd36d02393bd34ca74f08bf547b437e0983f62f";

  await parse(rawTx);

}

main();
